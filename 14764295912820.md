# 杭州多酷对账数据
9月份购买酷点总数  1220473939

当前用户结余：2016-10-14 15:23:40  1011032

```sql
 --当前用户结余
     select now(),kp_balance from oem_user where name ='杭州多酷' 
```

截止2016-10-14 15:23:40 发给玩家总数：165150
截止2016-10-14 15:23:40 发给玩家撤回总数:0
截止2016-10-14 15:23:40 给二级发放总数:0
截止2016-10-14 15:23:40 一级给二级撤回总数:0
截止2016-10-14 15:23:40 管理员给一级总数:0
截止2016-10-14 15:23:40 账户当前余额:1011032

截止2016-10-14 15:23:40 一级工会杭州多酷账户酷点 总数 845882


911032


给玩家无撤回
select sum(t. amount) amount from oem_voucher_grant t where t.t_create>? and ?> t.t_create and t.state=1 and t.grant_type=0 and t.t_abort is null and t.creator_id = ? 

创建时间在运行周期之前 撤回时间在运行周期以内
select sum(t.amount) amount from oem_voucher_grant t where ? > t.t_create and t.t_abort is not null and t.grant_type=0 and t.t_abort> ? and ?>t.t_abort and t.creator_id = ? 

--一级给二级 无撤回(related_id是发放者ID 给玩家user_id是发放者ID)
select sum(t.amount) amount from `oem_kp_event` t where t.time>? and ?>t.time and t.type=3 and t.related_id = ?

--一级给二级 撤回
select sum(t.amount) amount from `oem_kp_event` t where t.t_expire>? and ?>t.t_expire and t.type=5 and t.user_id = ? 

--管理员给一级
select sum(t.amount) amount from oem_kp_grant t where t.t_grant>? and ?>t.t_grant and t.user_id = ?



--发放失败 上一次


杭州多酷 9月结余 776182 
##一级给二级撤回  统一数据格式
9568,9569,9570,9571,9572,9573,9574,9575,9576


2016-10-15.19:38:56.655 [DEBUG] c.d.d.c.A.selectGrantToplayerSumGroupByUidWithMonth 132 debug ==>  Preparing: select sum(t. amount) amount from oem_voucher_grant t where t.t_create>=? and ?> t.t_create and t.state=1 and t.grant_type=0 and t.t_abort is null and t.creator_id = ? 
2016-10-15.19:38:56.656 [DEBUG] c.d.d.c.A.selectGrantToplayerSumGroupByUidWithMonth 132 debug ==> Parameters: 2016-09-30.12:00:03(String), 2016-10-15 19:38:55.0(Timestamp), 9575(Integer)
2016-10-15.19:38:56.672 [DEBUG] c.d.d.c.A.selectGrantToplayerSumGroupByUidWithMonth 132 debug <==      Total: 1
2016-10-15.19:38:56.673 [DEBUG] c.d.d.c.A.selectAbortToplayerSumGroupByUidWithMonth 132 debug ooo Using Connection [com.mysql.jdbc.JDBC4Connection@2caf0a91]
2016-10-15.19:38:56.673 [DEBUG] c.d.d.c.A.selectAbortToplayerSumGroupByUidWithMonth 132 debug ==>  Preparing: select sum(t.amount) amount from oem_voucher_grant t where ? > t.t_create and t.t_abort is not null and t.grant_type=0 and t.t_abort>= ? and ?>t.t_abort and t.creator_id = ? 
2016-10-15.19:38:56.674 [DEBUG] c.d.d.c.A.selectAbortToplayerSumGroupByUidWithMonth 132 debug ==> Parameters: 2016-09-30.12:00:03(String), 2016-09-30.12:00:03(String), 2016-10-15 19:38:55.0(Timestamp), 9575(Integer)
2016-10-15.19:38:56.688 [DEBUG] c.d.d.c.A.selectAbortToplayerSumGroupByUidWithMonth 132 debug <==      Total: 1
2016-10-15.19:38:56.689 [DEBUG] c.d.d.c.A.selectGrantToChild4ChildSumGroupByUidWithMonth 132 debug ooo Using Connection [com.mysql.jdbc.JDBC4Connection@2caf0a91]
2016-10-15.19:38:56.690 [DEBUG] c.d.d.c.A.selectGrantToChild4ChildSumGroupByUidWithMonth 132 debug ==>  Preparing: select sum(t.amount) amount from `oem_kp_event` t where t.time>=? and ?>t.time and t.type=3 and t.user_id = ? 
2016-10-15.19:38:56.691 [DEBUG] c.d.d.c.A.selectGrantToChild4ChildSumGroupByUidWithMonth 132 debug ==> Parameters: 2016-09-30.12:00:03(String), 2016-10-15 19:38:55.0(Timestamp), 9575(Integer)
2016-10-15.19:38:56.697 [DEBUG] c.d.d.c.A.selectGrantToChild4ChildSumGroupByUidWithMonth 132 debug <==      Total: 1
2016-10-15.19:38:56.698 [DEBUG] c.d.d.c.A.selectAbortToChild4ChildSumGroupByUidWithMonth 132 debug ooo Using Connection [com.mysql.jdbc.JDBC4Connection@2caf0a91]
2016-10-15.19:38:56.698 [DEBUG] c.d.d.c.A.selectAbortToChild4ChildSumGroupByUidWithMonth 132 debug ==>  Preparing: select sum(t.amount) amount from `oem_kp_event` t where t.t_expire>=? and ?>t.t_expire and t.type=5 and t.related_id = ? 
2016-10-15.19:38:56.699 [DEBUG] c.d.d.c.A.selectAbortToChild4ChildSumGroupByUidWithMonth 132 debug ==> Parameters: 2016-09-30.12:00:03(String), 2016-10-15 19:38:55.0(Timestamp), 9575(Integer)
2016-10-15.19:38:56.811 [DEBUG] c.d.d.c.A.selectAbortToChild4ChildSumGroupByUidWithMonth 132 debug <==      Total: 1
-------------------
AccountBalanceDetailBean [userId=9575, toPlayerAmount=138815, abortPlayerAmount=0, toChildAmount=200000, abortChildAmount=0, toAccountAmount=0, balanceByNow=99974, balanceOfLastMonth=38789]





当月结余酷点（截止9.30 23:59已发放给玩家，但是玩家未消费的酷点）
select * from user_voucher_store_0 t1 inner join crm_voucher_oem_log t2 on t1.`voucher_id`=t2.`voucher_id` 
	where t1.`use_status`=0 and t1.`voucher_money`!=t1.`remain_voucher_money` and t1.`obtain_time`<'2016-10-01 00:00:00' and t1.`expire_time`>='2016-10-01 00:00:00'
	and t2.`oem_channel_id`=9274
	
	
	select * from user_voucher_store_0 t1 inner join crm_voucher_oem_log t2 on t1.`voucher_id`=t2.`voucher_id` 
	where t1.`use_status`=0 and t1.`voucher_money`!=t1.`remain_voucher_money` and t1.`obtain_time`<'2016-10-01 00:00:00' and t1.`expire_time`>='2016-10-01 00:00:00'
	and t2.`oem_channel_id`=9274
union all
select * from user_voucher_store_1 t1 inner join crm_voucher_oem_log t2 on t1.`voucher_id`=t2.`voucher_id` 
	where t1.`use_status`=0 and t1.`voucher_money`!=t1.`remain_voucher_money` and t1.`obtain_time`<'2016-10-01 00:00:00' and t1.`expire_time`>='2016-10-01 00:00:00'
	and t2.`oem_channel_id`=9274
union all
select * from user_voucher_store_2 t1 inner join crm_voucher_oem_log t2 on t1.`voucher_id`=t2.`voucher_id` 
	where t1.`use_status`=0 and t1.`voucher_money`!=t1.`remain_voucher_money` and t1.`obtain_time`<'2016-10-01 00:00:00' and t1.`expire_time`>='2016-10-01 00:00:00'
	and t2.`oem_channel_id`=9274
union all
select * from user_voucher_store_3 t1 inner join crm_voucher_oem_log t2 on t1.`voucher_id`=t2.`voucher_id` 
	where t1.`use_status`=0 and t1.`voucher_money`!=t1.`remain_voucher_money` and t1.`obtain_time`<'2016-10-01 00:00:00' and t1.`expire_time`>='2016-10-01 00:00:00'
	and t2.`oem_channel_id`=9274
union all
select * from user_voucher_store_4 t1 inner join crm_voucher_oem_log t2 on t1.`voucher_id`=t2.`voucher_id` 
	where t1.`use_status`=0 and t1.`voucher_money`!=t1.`remain_voucher_money` and t1.`obtain_time`<'2016-10-01 00:00:00' and t1.`expire_time`>='2016-10-01 00:00:00'
	and t2.`oem_channel_id`=9274
union all
select * from user_voucher_store_5 t1 inner join crm_voucher_oem_log t2 on t1.`voucher_id`=t2.`voucher_id` 
	where t1.`use_status`=0 and t1.`voucher_money`!=t1.`remain_voucher_money` and t1.`obtain_time`<'2016-10-01 00:00:00' and t1.`expire_time`>='2016-10-01 00:00:00'
	and t2.`oem_channel_id`=9274
union all
select * from user_voucher_store_6 t1 inner join crm_voucher_oem_log t2 on t1.`voucher_id`=t2.`voucher_id` 
	where t1.`use_status`=0 and t1.`voucher_money`!=t1.`remain_voucher_money` and t1.`obtain_time`<'2016-10-01 00:00:00' and t1.`expire_time`>='2016-10-01 00:00:00'
	and t2.`oem_channel_id`=9274
union all
select * from user_voucher_store_7 t1 inner join crm_voucher_oem_log t2 on t1.`voucher_id`=t2.`voucher_id` 
	where t1.`use_status`=0 and t1.`voucher_money`!=t1.`remain_voucher_money` and t1.`obtain_time`<'2016-10-01 00:00:00' and t1.`expire_time`>='2016-10-01 00:00:00'
	and t2.`oem_channel_id`=9274
union all
select * from user_voucher_store_8 t1 inner join crm_voucher_oem_log t2 on t1.`voucher_id`=t2.`voucher_id` 
	where t1.`use_status`=0 and t1.`voucher_money`!=t1.`remain_voucher_money` and t1.`obtain_time`<'2016-10-01 00:00:00' and t1.`expire_time`>='2016-10-01 00:00:00'
	and t2.`oem_channel_id`=9274
union all
select * from user_voucher_store_9 t1 inner join crm_voucher_oem_log t2 on t1.`voucher_id`=t2.`voucher_id` 
	where t1.`use_status`=0 and t1.`voucher_money`!=t1.`remain_voucher_money` and t1.`obtain_time`<'2016-10-01 00:00:00' and t1.`expire_time`>='2016-10-01 00:00:00'
	and t2.`oem_channel_id`=9274	




SELECT
	sum(cost_money)AS tc
FROM
	(
		SELECT DISTINCT
			a.cost_money,
			a.voucher_unique_id
		FROM
			(
				SELECT
					*
				FROM
					crm.user_voucher_balance_detail_ { $i }
				WHERE
					create_time > '{$endTime}'
				AND use_type = 15
			)a
		LEFT OUTER JOIN crm.user_voucher_store_ { $i } b ON a.user_voucher_store_id = b.id
		LEFT OUTER JOIN { $database }.oem_voucher_grant c ON b.original_voucher_unique_id = c.voucher_id
		LEFT OUTER JOIN { $database }.oem_user d ON c.creator_id = d.id
		WHERE
			b.obtain_time <= '{$endTime}'
		AND(
			d.id = $parentId
			OR d.creator_id = $parentId
		)
	)t

SELECT
	sum(

		IF(
			a.voucher_type = 2,
			a.remain_voucher_money,
			a.voucher_money
		)
	)lm
FROM
	(
		SELECT
			*
		FROM
			crm.user_voucher_store_ { $i }
		WHERE
			use_type = 15
		AND expire_time > '{$endTime}'
		AND use_status = 0
		AND obtain_time <= '{$endTime}'
	)a
LEFT OUTER JOIN { $database }.oem_voucher_grant b ON a.original_voucher_unique_id = b.voucher_id
LEFT OUTER JOIN { $database }.oem_user c ON b.creator_id = c.id
WHERE
	b.voucher_id IS NOT NULL
AND(
	c.id = $parentId
	OR c.creator_id = $parentId
)



----
SELECT sum(cost_money) AS tc
FROM
  (SELECT DISTINCT a.cost_money,
                   a.voucher_unique_id
   FROM
     (SELECT *
      FROM crm.user_voucher_balance_detail_0
      WHERE create_time > '2016-10-01 00:00:00'
        AND use_type = 15) a
   LEFT OUTER JOIN crm.user_voucher_store_0 b ON a.user_voucher_store_id = b.id
   LEFT OUTER JOIN cps.oem_voucher_grant c ON b.original_voucher_unique_id = c.voucher_id
   LEFT OUTER JOIN cps.oem_user d ON c.creator_id = d.id
   WHERE b.obtain_time <= '2016-10-01 00:00:00'
     AND (d.id = 221
          OR d.creator_id = 221)) t
          
          
          
select sum(if(a.voucher_type = 2,a.remain_voucher_money,a.voucher_money)) lm 
from (select * from crm.user_voucher_store_0 
where use_type = 15 and expire_time > '2016-10-01 00:00:00' and use_status = 0 and obtain_time <= '2016-10-01 00:00:00') a 
left outer join cps.oem_voucher_grant b on a.original_voucher_unique_id = b.voucher_id 
left outer join cps.oem_user c on b.creator_id = c.id 
where b.voucher_id is not null and (c.id = '221' or c.creator_id = '221') 




















1·发放酷点代金券 kp_event5


渠道管理channelManagerMapper.xml
推广资源管理:populResourcesMapper.xml








oem_user kp_balance   
oem_voucher_grant					当天res >
oem_kp_event
oem_kp_grant

