# 订阅者业务梳理

##订阅者mcpcontent/mcp
###mcp_content_preview_action(监控表的insert/update/delete)
业务流程

##获取资源ID类型_publish_content_by_content_id

##_get_content_basic_info_by_content_id 根据游戏Id获取游戏数据
SELECT * FROM `mcp_content` WHERE `id` = %id
return 查询结果==null?oldColumns:result
如果整个方法返回null _publish_content_by_content_id->return -1;

·通过拿到游戏基础信息，也就是上面返回来的集合，获取游戏类型 具体游戏类型和编号的对应关系，可以看mcp_content_type表

如果type==16(百度主题) 查询：

```sql
SELECT
	C.`id`,
	C.`name`,
	C.`type_id`,
	ATE.`info`,
	ATE.`cp_id`,
	ATE.`grant_id`,
	ATE.`releasedate`,
	ATE.`froms`,
	ATE.`adapt`,
	ATE.`pop`,
	D.`id`,
	D.`path_url`,
	D.`size`,
	D.`jump_url`,
	GROUP_CONCAT(
		DISTINCT CL.`class_id`,
		',',
		CL.`priority`
	ORDER BY
		CL.`priority` DESC
	),
	GROUP_CONCAT(
		DISTINCT BL.`cb_id`
		ORDER BY
			BL.`cb_id`
	)AS cb_ids,
	GROUP_CONCAT(
		DISTINCT COL.`column_id`,
		',',
		COL.`priority`
	ORDER BY
		COL.`column_id`
	),
	GROUP_CONCAT(
		DISTINCT PV.`image_type_id`,
		',',
		PV.`image_url`
	ORDER BY
		PV.`priority` DESC
	),
	GROUP_CONCAT(
		DISTINCT R.`ptype_id`,
		',',
		R.`priority`
	ORDER BY
		R.`ptype_id`
	)
FROM
	`MCP`.`mcp_content` AS C
INNER JOIN(
	`MCP`.`mcp_content_theme_android_ext` AS ATE
	INNER JOIN `MCP`.`mcp_content_cp` AS CP ON CP.`id` = ATE.`cp_id`
	AND CP.`enable` = 1
)ON ATE.`id` = C.`ext_id`
AND ATE.`enable` = 1
AND C.`type_id` = 16
INNER JOIN `MCP`.`mcp_content_class_list` AS CL ON CL.c_id = C.id
AND CL. ENABLE = 1
LEFT JOIN `MCP`.`mcp_content_data` AS D ON D.`c_id` = C.`id`
AND D.`enable` = 1
AND D.`visible` = 1
LEFT JOIN `MCP`.`mcp_content_preview` AS PV ON PV.`c_id` = C.`id`
AND PV.`enable` = 1
LEFT JOIN `MCP`.`mcp_content_bookmark_list` AS BL ON BL.`c_id` = C.`id`
AND BL.`enable` = 1
LEFT JOIN `MCP`.`mcp_content_column_list` AS COL ON COL.`c_id` = C.`id`
AND COL.`enable` = 1
LEFT JOIN `MCP`.`mcp_content_rank` AS R ON R.`c_id` = C.`id`
WHERE
	C. ENABLE = 1
AND C. STATUS = 1
AND C.visible = 1
AND D.`channel_info` = 'DuoKu'
AND C.`id` = 1416859
GROUP BY
	C.id
ORDER BY
	ATE.`releasedate` DESC
	
 ```        

 
 
 查询结果==null?删除MG记录:更新MG记录
 
 如果type==23(IOS应用，废弃) 
 
 //25：网游 31：游戏攻略
## if 25 or 31 执行 _publish_mcp_online_game_by_content_id 
执行查询：
```sql
SELECT
	C.`id`,
	C.`name`,
	C.`type_id`,
	GE.`info`,
	GE.`version`,
	GE.`adapt`,
	GE.`cp_id`,
	GE.`star`,
	GE.`enName`,
	GE.`language`,
	GE.`updatedate`,
	GE.`updatedate`,
	GE.`updatedate`,
	D.`id`,
	D.`path_url`,
	D.`jump_url`,
	D.`size`,
	CC.`value`,
	GROUP_CONCAT(
		DISTINCT CL.`class_id`,
		',',
		CL.`priority`
	ORDER BY
		CL.`priority` DESC
	),
	GROUP_CONCAT(
		DISTINCT BL.`cb_id`
		ORDER BY
			BL.`cb_id`
	),
	GROUP_CONCAT(
		DISTINCT COL.`column_id`,
		',',
		COL.`priority`
	ORDER BY
		COL.`column_id`
	),
	GROUP_CONCAT(
		DISTINCT PV.`image_type_id`,
		',',
		PV.`image_url`
	ORDER BY
		PV.`priority` DESC
	),
	GROUP_CONCAT(
		DISTINCT R.`ptype_id`,
		',',
		R.`priority`
	ORDER BY
		R.`ptype_id`
	),
	GROUP_CONCAT(
		DISTINCT A.`type`,
		'^',
		A.`content`
	ORDER BY
		A.`type`
	),
	D.`channel_info`,
	GE.`pub_props`,
	GE.`editor_recom`
FROM
	`MCP`.`mcp_content_game_ext` AS GE
INNER JOIN `MCP`.`mcp_content` AS C ON C.`id` = GE.`c_id`
AND(C.`type_id` = 25 OR C.`type_id` = 31)
AND C. ENABLE = 1
AND C. STATUS = 1
AND C.visible = 1
INNER JOIN `MCP`.`mcp_content_cp` AS CP ON CP.`id` = GE.`cp_id`
AND CP.`enable` = 1
LEFT JOIN `MCP`.`mcp_content_class_list` AS CL ON CL.c_id = C.id
AND CL. ENABLE = 1
INNER JOIN(
	`MCP`.`mcp_content_data` AS D
	LEFT JOIN `MCP`.`mcp_content_charge` AS CC ON CC.`cdata_id` = D.`id`
	AND CC.`enable` = 1
)ON D.`c_id` = C.`id`
AND D.`enable` = 1
AND D.`visible` = 1
AND(
	D.`channel_info` = 'Duoku'
	OR D.`channel_info` = 'TEMP'
)
LEFT JOIN `MCP`.`mcp_content_preview` AS PV ON PV.`c_id` = C.`id`
AND PV.`enable` = 1
LEFT JOIN `MCP`.`mcp_content_bookmark_list` AS BL ON BL.`c_id` = C.`id`
AND BL.`enable` = 1
LEFT JOIN `MCP`.`mcp_content_column_list` AS COL ON COL.`c_id` = C.`id`
AND COL.`enable` = 1
LEFT JOIN `MCP`.`mcp_content_rank` AS R ON R.`c_id` = C.`id`
LEFT JOIN `MCP`.`mcp_content_attribute` AS A ON A.`c_id` = C.`id`
AND A.`enable` = 1
WHERE
	C.`id` = 1416859
GROUP BY
	C.id
ORDER BY
	GE.`gdate` DESC
```

mcp_content_data_Action

