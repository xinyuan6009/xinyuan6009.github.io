# CPS数据监控


##渠道商收支平衡监控
这个需求共分以下几个角色
1·账户当前结余 currNum
2·账户之前结余 oldNum
3·账号收入    income
4·账号支出	 outcome

一·系统运行过程描述
	1·系统启动生成快照时间 startTime=now;
	2·加载用户快照数据，freshSnaphot();  耗时点
		查询oem_user/oem_voucher -->add2redis
	3·启动定时任务
		生成计算结束时间 endTime=now;
		获取currNum findCurrNum();
		获取oldNum readFromRedis-->解析value-->获取num和Time
		获取income-->getIncome()  每个查询都伴随limit startTime,endTime;
			-->获取分配 getGrantNum();
			-->获取日结 getDayPayNum();
			-->获取撤回 getReBackNum();
		获取支出outcome-->getOutcome();
			-->获取发放给玩家 getGrant2PlayerNum();
			-->获取发放给二级账号 getGrant2ChildNum();
		校验数据-->validate(currNum,oldNum,income,outcome);
	
二·数据来源
currNum  
酷点：从oem_user(9034)直接查询
代金券：从oem_voucher(2460)查询

oldNum:
系统初始化：查询账号当前余额，生成快照放入redis缓存
非初始化：从redis获取保存数据

酷点
key cps_minitor_snaphot_userid_coin value:num_time
代金券
key cps_minitor_snaphot_userid_voucherId_voucher value:num_time
考虑保存数据库

缓存解释：
KEY  特征项 cps_minitor_snaphot  主要用来描述KEY所属系统以及KEY的功能
		userid	用来将KEY与用户绑定
		coin/voucher	用来区分酷点还是代金券
VALUE	num_time	
		num:标示数量快照
		time:标示快照时间 时间格式yyyy-MM-dd HH:mm:ss
		举例：10_2016-09-01 12:11:20

income
	1·MGR分配grantNum：酷点 oem_kb_grant(4)  代金券 oem_voucher_grant(530207)
	2·日结dayPay：查询oem_kp_count(4)
	3·撤回 reback：酷点 oem_kp_event(11245)  代金券  oem_voucher(2460)
	oem_voucher_grant 确认撤回是否修改发放记录表
	给玩家发放查询oem_voucher_grant 给二级账号发放查询oem_coin_balance
	
	4·定时脚本撤回：暂时没有对应的记录表

outcome:
	发放给二级账号或者玩家 grantToNum:酷点 oem_coin_balance(94513)  代金券 oem_coin_balance
	给玩家发放查询oem_voucher_grant 给二级账号发放查询oem_coin_balance
	批量发放酷点：查询oem_voucher_grant
	
		
三·平衡条件
oldNum + income + (-outcome) = currNum;

四·补充
	系统启动时，做快照初始化操作，任务调度间隔暂时定为30分钟一次 可配
从数据量上看 收入数据了明显小于支出，支出数据集中在oem_voucher_grant上，所以耗时主要集中在对
oem_voucher_grant表的查询


##代币/酷点发放流程监控（针对批量操作）
金币总额监控

一·酷点/代币批量发放流程
![](media/14742677168004/14742801595645.jpg)


一·系统运行过程描述
	发放过程监控·金额
	1·项目启动，初始化操作，记录系统启动时间startTime=now
		将生成的时间放入缓存 -->add2Redis();
	2·启动定时任务 生成计算结束时间 endTime=now
	3·获取本时间段CPS批处理成功记录列表 getGrantList();
	4·获取CPS记录中得发放成功的酷点/代金券数量总数totalAmount4Cps  
			-->getTotalAmount4Cps();
	5·获取CRM系统记录中的发放成功的酷点/代金券数量总和totalAmount4Crm 
			-->getTotalAmount4Crm();
	6·validate(countNum4Cps,countNum4Crm)
		if(countNum4Cps!=countNum4Crm){
			alert();	//报警
			log();	//记录日志
		}
  7·更新缓存时间,将计算结束时间设置为下一次任务运行的开始时间			-->updateStartTime4Redis(endTime);
  
 二·redis设计
 	金额：
 	key cps_monitor_oprtime_amount value:time
 	
 	发放过程监控·次数
 	1·项目启动，初始化操作，记录系统启动时间startTime=now
		将生成的时间放入缓存 -->add2Redis();
	2·启动定时任务 生成计算结束时间 endTime=now
	3·获取本时间段CPS批处理成功记录列表 getGrantList();
	4·获取CPS记录中得发放成功的酷点/代金券次数总和totalCount4Cps  
			-->getTotalCount4Cps();
	5·获取CRM系统记录中的发放成功的酷点/代金券次数总和totalCount4Crm 
			-->getTotalCount4Crm();
	6·validate(totalCount4Cps,totalCount4Crm)
		if(totalCount4Cps!=totalCount4Crm){
			alert();	//报警
			log();	//记录日志
		}
  7·更新缓存时间,将计算结束时间设置为下一次任务运行的开始时间			-->updateStartTime4Redis(endTime);
 	
 二·redis设计
 	次数：
 	key cps_monitor_oprtime_times  value:time


##账号盗号监控
一·系统运行流程
	1·加载配置文件，配置项主要包含 
		1）指定时间内发放酷点/代金券次数阀值 2)一次发放的限额阀值
		-->loadConf();
		配置文件存在DB，数据结构1)interval_times  2)maxAmount
		在项目初始化的时候刷到内存 --reloadConf();
		获取配置数据  -->getConf()
		if(conf==null){
			reloadConf();
		}
		项目启动，初始化操作，记录系统启动时间startTime=now
		将生成的时间放入缓存 -->add2Redis();
	2·扫描CPS酷点/代金券发放记录表信息，分析是否存在超额数据
		指定时间内发放酷点/代金券阀值
		findExcepLogForIntervalTimes()
			1·获取所有的记录数据 getLogDataList()-->list
			2·遍历查找异常数据，挨个遍历项目
			
			```java
			for(;;){
				log = list.get(i);
				logTimes = select count(1) from log_tb where 			startTime<logTime<log.getLogTime+interval
				if(logTimes>=times){
					alert();	//报警
					log();	//记录日志
				}
			}
			```
			
		一次发放的限额阀值
			1·获取所有的记录数据 getLogDataList()-->list
			2·遍历查找异常数据，挨个遍历项目
			
			```java
			for(;;){
				log = list.get(i);
				if(log.getAmout()>=maxAmount){
					alert();	//报警
					log();	//记录日志
				}
			}
			```
			
		3·更新系统时间 startTime=list.get(last).getLogTime();
		
		
--------------------------------------------------------		  
数据库
报警类型表 共分一下几类:
商户收支报警 批量发放金额报警 批量发放次数报警 
账户发放异常报警 账户单词发放超限报警
cps_monitor_alert_type
id:唯一ID
name:报警类型名称
desc:报警类型描述

报警表
cps_monitor_alert
id:报警ID
level:报警级别 默认 0 
type:报警类型    1·CRM/CPS发放数量不一致  2·CRM/CPS发放金额不一致
ctime:报警创建时间
desc:描述

系统配置表
比如一定时间内发放次数限制配置，还有一次发放超限配置
配置类型暂时就上面两种
cps_monitor_conf
id:配置ID
type:配置类型  
value:配置值
desc:配置描述




