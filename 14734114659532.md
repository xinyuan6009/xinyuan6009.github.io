# 项目结构

##用户登录 

```sql
SELECT
	id,
	username,
	PASSWORD,
	salt,
	role,
	STATUS,
	privilege,
	t_create,
	t_update,
	t_delete,
	t_login,
	creator_id,
	NAME,
	COMMENT,
	kp_balance,
	kb_balance,
	paypass,
	paysalt,
	sms_phone,
	email,
	permission,
	account_type
FROM
	oem_user
WHERE
	username =?
AND role IN(3, 4, 8, 9, 10)
AND STATUS != 2
```


##数据监控
数据的变更总和应该是一个常量，中途若出现任何不一致，都需要出现报警操作。


16-09-12 12:20:29 INFO main 861 - CODE: MESSAGE_ILLEGAL  DESC: the message is illegal, maybe length not matched.
For more information, please visit the url, https://github.com/alibaba/RocketMQ/issues/64
16-09-12 12:20:29 INFO main 401 - Send MSG to MQ failed!

##业务
向游戏玩家发放酷点
1·扣除用户酷点userMapper  直接修改oem_user表中的数据
2·请求crm系统 crm会记录操作数据
3·获取crm返回数据，如果返回数据正常，将操作结果插入表


2·请求CRM后台

3·向代金券表插入数据oem_voucher_grant
insert into oem_voucher_grant (creator_id,voucher_id,type,grant_type,related_id,amount,cid,cids,t_expire,user_sys,username,user_id,state,t_create,t_complete,t_abort,task_id,err_code,order_id)
values(#{creator_id},#{voucher_id},#{type},#{grant_type},#{related_id},#{amount},#{cid},#{cids},		#{t_expire},#{user_sys},#{username},#{user_id},#{state},#{t_create},#{t_complete},#{t_abort},#{task_id},#{err_code},#{order_id})

4·向oem_coin_balance（代币收支明细）插入记录

-------------------------------------------------------------------

向二级账号发放酷点流程
0·添加酷点操作记录日志
1·对父级账号做减操作
2·对子级账号做增操作
3·向oem_coin_balance插入记录

向二级子账号发放酷点优化
1·controller调用service service无需重新获取用户数据
2·addKpEvent没有做事务控制


问题：
批量给玩家发酷点，HTML页面有一部分隐藏代码，不知道是否还有用

```html
<!-- 这部分已经被隐藏 有什么用呢 -->
					<div class="disToChild" style="display:none">
						<div class="setDRule">
							<p>设置分配规则</p>
							<div class="floor_1">
								<label for="">输入子账户</label>
								<input type="text" placeholder="请输入子账户（支持1人）">
								<p style="display:none">您输入的子账户不存在</p>
							</div>
							<div class="floor_2">
								<label for="">输入酷点值</label>
								<input type="text">
								<span>酷点/人</span>
								<p style="display:none">抱歉，您的可用库点不足</p>
							</div>
							<div class="floor_3" style="display: none;">
								<label for="">失效日期</label>
								<input id="unuseTime" type="text">
								<span>00:00:00</span>
								<p style="display:none">请选择失效日期</p>
							</div>
							<div class="floor_4">
								<label for="">分配金额</label>
								<p>共计<span></span>酷点</p>
							</div>
							<a class="ofCouse" href="javascript:;" id="ofCourseAllUser">确定</a>
						</div>	
					</div>
```



渠道商酷点
·增加
MGR后给分配
日结（CPS前台维护·旭光）
撤回(CPS后台维护·欧阳 吕超)
定时脚本撤回（玩家发放失败·旭光）

·减少
酷点成功发放
给二级渠道发放


渠道商代金券
·增加
MGR分配
撤回(CPS后台维护·欧阳 吕超)
定时脚本撤回（玩家发放失败·旭光）

·减少
代金券发放给玩家



