# 手机卫士广告
##需求分析

重要参数说明：
1·cuid:设备编号，主要用来做个性化
2·boardid:榜单ID，用来定位榜单类型
3·fr:渠道号，用户定位游戏下载信息

参数解析：
cuid与boardid主要用来获取游戏的cid列表
fr主要用来获取游戏的下载信息

##数据源
### 基础数据来源(MG/mcp_duoku_appinfo)
c_id	**(y)**
name	**(y)**
update_time
rating
logo	**(y)**
intro
game_img
tags
type
platform
isfree
brief	**(y)**
download_num

### 其他数据来源
//mcp_content_appinfo (最新，appId>0,modify_date倒序)
version(最新、上线)	**(y)**
version_code(最新、上线)	**(y)**
package_name(最新、上线)	**(y)**

//mcp_content_data
size	size	**(y)**
apk_update_time  modify_date
apkmd5 md5	**(y)**

//game_oem/oem_game.oem_game_packages
download_url(最新、上线) path 

##系统设计

###缓存设计(QA测试开启DEBUG日志，时间可以调整为5-15min)
1·游戏基础信息缓存，每五分钟刷新一次，数据来源MG
key->api_base_cid_game value->GameBasicObject
2·游戏渠道管理数据缓存，每五分钟刷新一次，数据来源MYSQL
key->api_fr_cid_info value->GameFrObject
3·个性化游戏数据缓存，五分钟过期，有reload机制
key->api_fr_cuid_boardid_game  value->games
###数据刷新流程
1·游戏信息缓存流程(内存)

```java
	loadBasicInfo(){
		while(load()){
			GameBasicObject obj = MG.getGameBasicObj();
			cache.put(api_base_cid_game_tmp,obj);
			for(;frs;){
				GameFrObject frObj = Mysql.getGameFrObj();
				cache.put(api_fr_cid_info,frObj);
			}
		}
	};
```	

2·个性化游戏数据缓存(redis)

```java
reload(cuid,fr,boardid){
	//获取cids
	cids = ubService.getCidsFromBasic(cuid,fr,boadid,size);
	for(;cids;){
		//从缓存
		GameBasicObject obj = cache.getGameBasicObj();
		GameFrObject frObj = cache.getGameFrObj();
		Game game = MergeService.merge(obj,frObj);
		
	}
	cache.put(api_fr_cuid_game,games);
	cache.expire(5min);
}

```

  
## 流程图
客户端请求流程

```flow
st=>start: 开始
e=>end: 结束
op=>operation: 获取榜单数据
cond=>condition: 确认？
reload=>operation: reload

st->op->cond
cond(yes)->e
cond(no)->reload
reload->e
```

系统架构
![](media/14691829661409/14691855546315.jpg)

##系统结构
1·包结构
com.baidu.mg.api.controller
com.baidu.mg.api.service
com.baidu.mg.api.bean
com.baidu.mg.api.util
com.baidu.mg.api.dao
2·项目组成
SpringMvc+Mybatis+Mysql
3·配置文件
maven-profile:dev/test/online
3·项目构建
maven
4·其他
monitor

##问题：
1·download_url 从哪里获取比较合适
2·服务器负载如何做，是否用ZK？


##补充
每隔一小时从UB拉取默认数据

##开发

```mg
[ "wap/31000/31491/as_1.jpg" , "wap/31000/31491/as_2.jpg" , "wap/31000/31491/as_3.jpg" , "wap/31000/31491/as_4.jpg"]
```

游戏和打包数据

```sql
SELECT S.`id`, S.`c_id`,D.`channel_id`, S.`app_name`, S.`package_name`, S.`version_code`, S.`version`, S.`sdk_version`, S.`permissions`, S.`features`, S.`apk_info` 
            FROM `MCP`.`mcp_content_appinfo` AS S LEFT JOIN `MCP`.`mcp_content` AS C on S.`c_id`=`C`.id 
            LEFT JOIN `MCP`.`mcp_content_data` AS D ON S.`c_id` = D.`c_id` 
            WHERE `C`.id = 32220
            AND C.enable=1 
            AND C.status=1 
            AND D.`channel_info`='DuoKu' 
            AND D.enable=1
            
SELECT DISTINCT(C.id), C.name, C.type_id, GE.updatedate, C.ext_id, GE.info, GE.version, GE.method, GE.star, GE.network_id,  
             GE.game_code, GE.cp_id, GE.grant_id, C.charge_typeid, C.charge_value, GE.updatedate,  
             GE.`enName`, GE.`language`,  GE.`adapt`,  
             GE.`pub_props`, GE.`client_class_weight`, GE.`client_latest_weight`, GE.`client_download_weight`, GE.`client_pop_weight`,  
             GE.`class_weight`, GE.`latest_weight`, GE.`download_weight`, GE.`pop_weight`, GE.`updatedate`, GE.`editor_recom`  
             , GE.`search_weight`, GE.`show_highspeed`, GE.`bind_resource_id`  
             FROM  mcp_content AS C  
             INNER JOIN  mcp_content_class_list AS CL ON CL.c_id = C.id AND CL.enable = 1  
             INNER JOIN mcp_content_data AS CDATA ON (CDATA.c_id = C.id AND CDATA.channel_info != 'BaiduApp')  
             INNER JOIN (mcp_content_game_ext AS GE  
             INNER JOIN mcp_content_cp AS CP ON CP.id = GE.cp_id AND CP.enable = 1)  
             ON GE.id = C.ext_id AND GE.enable = 1 AND GE.status = 1  
             WHERE C.enable = 1 AND C.status = 1  
             AND C.id = 32220
```

游戏关联数据获取SQL

```sql
select * from mcp_content_appinfo i 
INNER JOIN  mcp_content_data d ON i.`c_id`=d.`c_id`
where d.`c_id`=49148 AND d.`channel_info`="oem_15055"
order by d.`modify_date`
```

##进度
1·数据获取 90%
2·文件动态修改 100%
3·修改文件动态检验 100%

<!-- 引入jdbc配置文件 -->
	<context:property-placeholder location="classpath:properties/*.properties" />

select * from mcp_content_appinfo i INNER JOIN mcp_content_data d ON i.`c_id`=d.`c_id` where d.`c_id`=? AND d.`channel_info`=concat('oem_',?) order by d.`modify_date` desc limit 1 
49148(Integer), 15055(Integer)


##项目测试
本地测试连接：http://localhost:8080/mquery/game/query.do?cuid=aaa&fr=15055&boardid=aaa&pageSize=10&pageNum=1
本地监控连接：http://localhost:8080/mquery/monitor/gameCache.do

98测试连接：http://192.168.0.98:8089/mquery/game/query.do?cuid=aaa&fr=15055&boardid=aaa&pageSize=10&pageNum=1
98监控连接：http://192.168.0.98:8089/mquery/monitor/gameCache.do

上海服务器：
http://10.202.7.102:8082/mquery/game/query.do?cuid=aaa&fr=15055&boardid=aaa&pageSize=10&pageNum=1
http://10.202.7.102:8082/mquery/monitor/gameCache.do



##pageSize和pageNum异常
pageSize:default==20
pageNum:要考虑非数字
pageNum大于总页数，返回空数组
刷新时间修改，可配置（不一定能改，需要调研）
默认绑定多少条
返回属性字段可配？
return_list可配
rec_type=5 这个有问题

redis setex

--data 'pageSize=20&cuid=23C0EBDAEE317D470689C4DE7AC7F5EB|503525050144953&pageNum=1&boardid=13578&fr=13443'，使用json的格式就不能够解析，但是文档中给的格式是json，所以想问下具体的post请求的格式

http://localhost:8080/mquery/game/query.do?cuid=23C0EBDAEE317D470689C4DE7AC7F5EB&fr=15055&boardid=13578&pageSize=20&pageNum=1


http://192.168.0.98:8089/mquery/game/query.do?cuid=aaa&fr=15654&boardid=aaa&pageSize=10&pageNum=1


##上线流程
1.文件上传192.168.0.98 
2.文件scp 10.63.111.31 
scp mquery.war work@10.63.111.31:~/mquery/ 
3.登录vpn
4.跳转到 ssh   hadoop@sh01-wise-yinli18.sh01.baidu.com
5.在sh01-wise-yinli18.sh01.baidu.com 中scp 10.63.111.31 中文件
6.分发到各个服务器中





String responseData = null;
		//解析响应数据head
        int headSize = NSHead.SIZE;
        
        long readS = System.currentTimeMillis();
        byte[] data=new byte[1024*10];
        
        for(int headLen=0;headLen!=-1;){
        	headLen=input.read(data);
        }
        
        long readE = System.currentTimeMillis();
        timesLog.info("Socket read体结束: reqId:{},耗时:{}",reqId,readE-readS);
        
        long buildS = System.currentTimeMillis();
        byte[] headBytes = new byte[headSize];
        System.arraycopy(data, 0, headBytes, 0, headSize);
        NSHead nsHead = NSHead.fromBytes(headBytes);
        int bodySize = nsHead.getBodyLen();//响应数据body长度
        byte[] bodyBytes = new byte[bodySize];
        System.arraycopy(data, headSize, bodyBytes, 0, bodySize);
        responseData = McpackUtil.decode(bodyBytes);
        long buildE = System.currentTimeMillis();
        timesLog.info("Socket read体结束: reqId:{},耗时:{}",reqId,buildE-buildS);
        
        timesLog.info("Socket read all体结束: reqId:{},耗时:{}",reqId,buildE-allS);
        return responseData;


./jmeter -n -t test_plans/api-mquery_500.jmx -R 192.168.1.119,192.168.1.115,192.168.1.113,192.168.1.117,192.168.1.107 -l test_plans/log/`date +%Y%m%d%H%M%S`_test.jtl


date +%Y-%-m-%-d-%H-%M-%S
mkdir $(date +%Y-%-m-%-d-%H-%M-%S)
性能测试：50并发 2500请求
总数：25037
>5000:173     0.7%
>200:276      1.1%
>150:793			3.0%
>100:2996		11%

性能测试：50并发 2500请求
日志目录：2016-8-8-15-45-16
cat server-times.log |grep 'getGames 请求结束耗时'|awk -F "：" '{if($2>500) print$2}'|wc -l
cat server-times.log |grep 'ads 结束'|awk -F "耗时:" '{if($2>500) print$1$2}'
总数:25001
大于500：79   0.3%
大于200：146  0.5%
大于150：613  2.5%


性能测试：50并发 2500请求
附加条件:setSotimeOut(true)
日志目录：2016-8-8-16-27-26

./jmeter -n -t test_plans/api-mquery_500.jmx -R 192.168.1.119,192.168.1.115 -l test_plans/log/`date +%Y%m%d%H%M%S`_test.jtl
性能测试：100并发 2500请求
附加条件:setSotimeOut(true)
日志目录：2016-8-8-16-52-42
总数：50000
大于500：149
大于200：43274


./jmeter -n -t test_plans/api-mquery_500.jmx -R 192.168.1.119,192.168.1.115,192.168.1.113,192.168.1.117,192.168.1.107 -l test_plans/log/`date +%Y%m%d%H%M%S`_test.jtl
总数:25002
大于200：182
数据不一致：329
平均耗时：310


ads服务器耗时统计：cat gameinfo_online.log|grep 'proctime:total'|awk '{t=$0;gsub(/.*proctime:total:|(ms).*/,"",t);print t}'|sort -n|wc -l

```shell
/mquery/game/query.do?cuid=${__Random(1,300000,random_num_0_300k)}&fr=15654&boardid=aaa&pageSize=10&pageNum=1
```

http://localhost:8080/mquery/game/query.do?cuid=23C0EBDAEE317D470689C4DE7AC7F5EB|503525050144953&fr=15657&boardid=1331515654002&pageSize=100&pageNum=1

http://192.168.0.98:8080/mquery/game/query.do?cuid=23111BDAEE317D470689C4DE7AC7F5EB|503525050144953&fr=15654&boardid=1331515654002&pageSize=100&pageNum=1

{"logId":2,"cuid":"23C0EBDAEE317D470689C4DE7AC7F5EB|503525050144953","req_key":"1331515654002","req_type":5,"searchid":"","info":{"return_list":"cid","sort_by_bid":1,"board_size":120}}

{"logId":1,"cuid":"","req_key":"1332015003","req_type":5,"searchid":"","info":{"return_list":"cid","sort_by_bid":1,"board_size":120}}

{"searchid": "1213413251243","req_type":5,"req_key": "1331515654002","cuid": "23C0EBDAEE317D470689C4DE7AC7F5EB|503525050144953","info": {"board_size": 100,"sort_by_bid": 1,"return_list": "cid"}}



{"logId":3,"cuid":"23C0EBDAEE317D470689C4DE7AC7F5EB|503525050144953","req_key":"1331515654002","req_type":5,"searchid":"","info":{"return_list":"cid","sort_by_bid":1,"board_size":120}}




[1551013, 1006902, 1501538, 1311548, 252881, 44289, 1512842, 63223, 1540663, 1274663, 534451, 1491378, 1571413, 1560641, 596298, 1538913, 146067, 193014, 1479956, 63427, 1453169, 1446398, 1054181, 252228, 72417, 1494897, 67537, 1598241, 1607463, 1357469, 1571198, 63440, 187544, 1166363, 446416, 198145, 1193456, 1213423, 943418, 1495067, 1388833, 1373965, 1534742, 1521775, 641495, 1115148, 138701, 1615418, 1481783, 1219089, 1550978, 874620, 91332, 601613, 67427, 1592557, 1387478, 1389024, 63039, 1307563, 151711, 1485230, 1372270, 1639341, 1372857, 883227, 1209769, 1423679, 1338942, 460921, 597811, 1617423, 1197807, 1604494, 61655, 67734, 1501941, 72268, 1416755, 1553396, 1163858, 458687, 1066404, 1605161, 423563, 1524540, 63301, 329190, 1378771, 1572261, 1597068, 1472364, 55308, 63040, 1604596, 1506712, 1003857, 1577085, 1482822, 1525222]

**[1551013, 1006902, 1501538, 1311548, 252881, 44289, 1512842, 63223, 1540663, 1274663, 534451, 1491378, 1571413, 1560641, 596298, 1538913, 146067, 193014, 1479956, 63427, 1453169, 1446398, 1054181, 252228, 72417, 1494897, 67537, 1598241, 1607463, 1357469, 1571198, 63440, 187544, 1166363, 446416, 198145, 1193456, 1213423, 943418, 1495067, 1388833, 1373965, 1534742, 1521775, 641495, 1115148, 138701, 1615418, 1481783, 1219089, 1550978, 874620, 91332, 601613, 67427, 1592557, 1387478, 1389024, 63039, 1307563, 151711, 1485230, 1372270, 1639341, 1372857, 883227, 1209769, 1423679, 1338942, 460921, 597811, 1617423, 1197807, 1604494, 61655, 67734, 1501941, 72268, 1416755, 1553396, 1163858, 458687, 1066404, 1605161, 423563, 1524540, 63301, 329190, 1378771, 1572261, 1597068, 1472364, 55308, 63040, 1604596, 1506712, 1003857, 1577085, 1482822, 1525222**

[1551013, 1006902, 1501538, 1311548, 252881, 44289, 1512842, 63223, 1540663, 1274663, 534451, 1491378, 1571413, 1560641, 596298, 1538913, 146067, 193014, 1479956, 63427, 1453169, 1446398, 1054181, 252228, 72417, 1494897, 67537, 1598241, 1607463, 1357469, 1571198, 63440, 187544, 1166363, 446416, 198145, 1193456, 1213423, 943418, 1495067, 1388833, 1373965, 1534742, 1521775, 641495, 1115148, 138701, 1615418, 1481783, 1219089, 1550978, 874620, 91332, 601613, 67427, 1592557, 1387478, 1389024, 63039, 1307563, 151711, 1485230, 1372270, 1639341, 1372857, 883227, 1209769, 1423679, 1550975, 1338942, 460921, 597811, 1617423, 1197807, 1385917, 61655, 67734, 1501941, 192886, 1416755, 1553396, 1491033, 458687, 1513991, 930573, 63301, 329190, 1378771, 1597068, 175931, 1551119, 1592109, 1511867, 55308, 1563112, 1604596, 1642453, 1617035, 1551847, 1529207, 1525222, 251449]

cid               name
1006902  奔跑吧兄弟4-撕名牌大战
1311548  电玩街机捕鱼
44289     汤姆猫跑酷
63223    开心消消乐™







SD支付
11 给企业发二次校验  校验通过 更改订单状态 并给MQ发送消息




